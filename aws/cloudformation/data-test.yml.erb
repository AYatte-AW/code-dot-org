---
AWSTemplateFormatVersion: 2010-09-09
Description: test DMS custom resources.
# Parameters can be provided via CDO.underscored_parameter, e.g. via locals.yml:
# redshift_password: abcdef
# Parameters are only required for initial stack creation, and reused if not provided on stack update.
<% rds = Aws::RDS::Client.new.describe_db_instances(db_instance_identifier: CDO.rds_identifier).db_instances.first -%>
Parameters:
  # MySQL user must have granted REPLICATION CLIENT and REPLICATION SLAVE permissions.
  # Ref: http://docs.aws.amazon.com/dms/latest/userguide/CHAP_Source.MySQL.html#CHAP_Source.MySQL.Security
  RDSUsername:
    Type: String
  RDSPassword:
    Type: String
    NoEcho: true
  RedshiftDatabase:
    Type: String
    Default: dashboard
  RedshiftUsername:
    Type: String
    Default: dev
  RedshiftPassword:
    Type: String
    NoEcho: true
  RDSHost:
    Type: String
  RedshiftHost:
    Type: String
Resources:
  VPC: <%= lambda.call 'LookupStackOutputs', StackName: 'VPC', Nonce: 0 %>
  DMSSubnetGroup: <%= lambda.call 'DMS',
    CustomType: 'ReplicationSubnetGroup',
    ReplicationSubnetGroupDescription: 'DMS Private Subnet Group',
    SubnetIds: azs.map{|az| {'Fn::GetAtt' => ['VPC', "Subnet#{az}"]}}
  %>
  TableauSyncInstance: <%= lambda.call 'DMS',
    CustomType: 'ReplicationInstance',
    VpcSecurityGroupIds: [{'Fn::GetAtt' => ['VPC', 'DBSecurityGroup']}],
    ReplicationInstanceClass: 'dms.t2.micro',
    AvailabilityZone: rds.availability_zone, # Same AZ as the source RDS instance.
    PubliclyAccessible: false,
    ReplicationSubnetGroupIdentifier: {Ref: 'DMSSubnetGroup'}
  %>
  RDSEndpoint: <%= lambda.call 'DMS',
    CustomType: 'Endpoint',
    EndpointType: 'source',
    EngineName: 'mysql',
    ServerName: {Ref: 'RDSHost'},
    Port: 3306,
    Username: {Ref: 'RDSUsername'},
    Password: {Ref: 'RDSPassword'}
  %>
  RedshiftEndpoint: <%= lambda.call 'DMS',
    CustomType: 'Endpoint',
    EndpointType: 'target',
    EngineName: 'redshift',
    ServerName: {Ref: 'RedshiftHost'},
    Port: 5439,
    Username: {Ref: 'RedshiftUsername'},
    Password: {Ref: 'RedshiftPassword'},
    DatabaseName: {Ref: 'RedshiftDatabase'}
  %>
  TableauSyncLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 30
  TableauSyncLogStream:
    Type: AWS::Logs::LogStream
    Properties:
      LogGroupName: {Ref: TableauSyncLogGroup}
  TableauSyncTask: <%= lambda.call 'DMS',
    CustomType: 'ReplicationTask',
    MigrationType: 'full-load-and-cdc',
    ReplicationInstanceArn: {Ref: 'TableauSyncInstance'},
    SourceEndpointArn: {Ref: 'RDSEndpoint'},
    TargetEndpointArn: {Ref: 'RedshiftEndpoint'},
    ReplicationTaskSettings: YAML.load(erb.call(File.expand_path(File.join(__dir__, '../dms/replication-task-settings.yml.erb')))).to_json,
    TableMappings: YAML.load(erb.call(File.expand_path(File.join(__dir__, '../dms/table-mappings.yml.erb')))).to_json
  %>
