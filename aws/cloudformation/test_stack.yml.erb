<%
commit = ENV['COMMIT'] || `git rev-parse HEAD`.split.first
ami = commit[0..4]
-%>
---
AWSTemplateFormatVersion: 2010-09-09
Description: Minimal test stack for AMI-builder.
Parameters:
  InstanceType:
    Type: String
    Default: t3.large
  ImageId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/canonical/ubuntu/server/18.04/stable/current/amd64/hvm/ebs-gp2/ami-id
Resources:
  # Stack-specific IAM permissions applied to both daemon and frontends.
  CDOPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: !Sub "Application permissions for ${AWS::StackName}."
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          # Instance-bootstrap CloudFormation hook.
          - Effect: Allow
            Action: 'cloudformation:SignalResource'
            Resource: !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}/*"
<%=
  component 'ami',
    ami: ami,
    frontend_policies: [Ref: 'CDOPolicy'],
    ssh_key_name: SSH_KEY_NAME,
    build_ami: <<~SH
      apt-get update
      apt-get -y install awscli

      INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
      STACK=${AWS::StackName}
      RESOURCE_ID=AMICreate#{ami}
      STATUS=SUCCESS
      REGION=${AWS::Region}
    SH
-%>
