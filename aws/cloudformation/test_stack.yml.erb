<%
commit = ENV['COMMIT'] || `git rev-parse HEAD`.split.first
-%>
---
AWSTemplateFormatVersion: 2010-09-09
Description: Minimal test stack for AMI-builder.
Resources:
  # Stack-specific IAM permissions applied to both daemon and frontends.
  CDOPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: !Sub "Application permissions for ${AWS::StackName}."
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          # Instance-bootstrap CloudFormation hook.
          - Effect: Allow
            Action: 'cloudformation:SignalResource'
            Resource: !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}/*"
<%= erb_file 'components/ami.yml.erb', commit: commit -%>
<%
  params[:InstanceType][:Default] = 't3.large'
  params[:ImageId] = {
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>',
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'
  }
-%>
Parameters: <%=params.to_json%>
