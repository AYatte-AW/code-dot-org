#!/bin/bash -x
# UserData bootstrap script for CloudFormation stack instances.
# This  script bootstraps, creates an AMI, then shuts itself down to save resources.
# Note: Minimize changes to this script! Every time its contents change,
# the next CloudFormation update will reboot all servers using this script.

echo -e "\n### Fetching and Installing Code..."

# Bootstrap prerequisites
apt-get update
apt-get -y install python-pip curl
test "$(pip show awscli)" || pip install awscli

STACK=<%=stack_name%>
REGION=<%=region%>
S3_BUCKET=<%=s3_bucket%>
ENVIRONMENT=<%=environment%>
RUN_LIST=<%=run_list%>
INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
NODE_NAME=<%=node_name%>

PENDING_AMI_HANDLE=%{"Ref": "WaitHandlePendingAMI"}
AMI_COMPLETE_HANDLE=%{"Ref": "WaitHandleAMIComplete"}

sudo -u ubuntu bash -c "aws s3 cp s3://${S3_BUCKET}/chef/bootstrap.sh - | sudo bash -s -- <%=local_mode ? '-z' : ''%> -n ${NODE_NAME} -r ${RUN_LIST} -e ${ENVIRONMENT}"
[ $? -eq 0 ] && STATUS=SUCCESS || STATUS=FAILURE

echo -e "\n### Signal for AMI capture..."
aws cloudformation signal-resource \
  --unique-id waitingforami \
  --stack-name ${STACK} \
  --logical-resource-id ${PENDING_AMI_HANDLE} \
  --status ${STATUS} \
  --region ${REGION} \
  || true

aws ec2 wait image-available \
  --filters Name=tag:cloudformation:amimanager:stack-name,Values=${STACK} \
  --region ${REGION} \
  || true

aws cloudformation signal-resource \
  --unique-id waitedforami \
  --stack-name ${STACK} \
  --logical-resource-id ${AMI_COMPLETE_HANDLE} \
  --status ${STATUS} \
  --region ${REGION} \
  || true

shutdown -h now
