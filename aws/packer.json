{
  "variables": {
    "branch": "staging",
    "root": "{{pwd}}",
    "key_path": "{{pwd}}"
  },
  "builders": [
    {
      "type": "amazon-instance",
      "account_id": "475661607190",
      "ami_name": "cdo-instance-{{timestamp}}",
      "instance_type": "c3.8xlarge",
      "region": "us-west-2",
      "s3_bucket": "cdo-dist",
      "source_ami": "ami-52c62032",
      "ssh_username": "ubuntu",
      "x509_cert_path": "{{user `key_path`}}/user_signing_certificate.pem",
      "x509_key_path": "{{user `key_path`}}/user_signing_certificate_key.pem",

      "availability_zone": "us-west-2b",
      "ami_groups": "all",
      "associate_public_ip_address": true,
      "force_deregister": true,
      "spot_price": "3",
      "security_group_id": "sg-af6d98c8",
      "subnet_id": "subnet-404a7937",
      "ami_block_device_mappings": [
        {
          "device_name": "/dev/sdb",
          "virtual_name": "ephemeral0",
          "volume_size": "32"
        }
      ],
      "launch_block_device_mappings": [
        {
          "device_name": "/dev/sdb",
          "virtual_name": "ephemeral0",
          "volume_size": "32"
        }
      ]
    },
    {
      "type": "amazon-ebs",
      "region": "us-west-2",
      "availability_zone": "us-west-2b",
      "source_ami": "ami-9abea4fb",
      "instance_type": "m4.10xlarge",
      "ssh_username": "ubuntu",
      "ami_name": "cdo-ebs-{{timestamp}}",
      "ami_groups": "all",
      "associate_public_ip_address": true,
      "force_deregister": true,
      "spot_price": "3",
      "security_group_id": "sg-af6d98c8",
      "subnet_id": "subnet-404a7937",
      "ami_block_device_mappings": [
        {
          "device_name": "/dev/sdb",
          "volume_size": "64",
          "delete_on_termination": true,
          "volume_type": "gp2"
        }
      ],
      "launch_block_device_mappings": [
        {
          "device_name": "/dev/sda1",
          "volume_size": "64",
          "delete_on_termination": true,
          "volume_type": "gp2"
        }
      ]
    },
    {
      "type": "docker",
      "image": "wjordan/ubuntu-chef:12.6.0",
      "commit": true,
      "pull": true,
      "volumes": {
        "{{user `root`}}": "/home/ubuntu/adhoc"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sudo -u ubuntu bash -c 'curl https://s3.amazonaws.com/cdo-dist/cdo-bootstrap.sh | sudo bash -s -- {{user `branch`}}'",
        "sudo -u ubuntu bash -c 'cd /opt/chef-zero && sudo /opt/chef/bin/chef-client -z -c solo.rb -o 'recipe[cdo-apps::stop]'"
      ]
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-tag",
        "repository": "wjordan/code-dot-org",
        "tag": "0.2",
        "force": true,
        "only": ["docker"]
      },
      {
        "type": "docker-push",
        "only": ["docker"]
      }
    ]
  ]
}
