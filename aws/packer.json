{
  "variables": {
    "branch": "staging",
    "root": "{{pwd}}",
    "key_path": "{{pwd}}",
    "access_key": "{{env `AWS_ACCESS_KEY_ID`}}",
    "secret_key": "{{env `AWS_SECRET_ACCESS_KEY`}}"
  },
  "builders": [
    {
      "type": "amazon-instance",
      "access_key": "{{user `access_key`}}",
      "secret_key": "{{user `secret_key`}}",
      "account_id": "475661607190",
      "ami_name": "cdo-instance-{{timestamp}}",
      "instance_type": "c3.8xlarge",
      "region": "us-west-2",
      "s3_bucket": "cdo-ami",
      "source_ami": "ami-52c62032",
      "ssh_username": "ubuntu",
      "ssh_pty": true,
      "x509_cert_path": "{{user `key_path`}}/user_signing_certificate.pem",
      "x509_key_path": "{{user `key_path`}}/user_signing_certificate_key.pem",

      "availability_zone": "us-west-2b",
      "ami_groups": "all",
      "ami_regions": ["us-east-1"],
      "ami_virtualization_type": "hvm",
      "associate_public_ip_address": true,
      "force_deregister": true,
      "security_group_id": "sg-af6d98c8",
      "subnet_id": "subnet-404a7937",
      "bundle_vol_command": "sudo -i -n ec2-bundle-vol -k {{.KeyPath}} -u {{.AccountId}} -c {{.CertPath}} -r {{.Architecture}} -e {{.PrivatePath}}/* -d {{.Destination}} -p {{.Prefix}} --batch --no-filter --partition mbr"
    },
    {
      "type": "amazon-ebs",
      "region": "us-west-2",
      "availability_zone": "us-west-2b",
      "source_ami": "ami-9abea4fb",
      "instance_type": "m4.10xlarge",
      "ssh_username": "ubuntu",
      "ami_name": "cdo-ebs-{{timestamp}}",
      "ami_groups": "all",
      "associate_public_ip_address": true,
      "force_deregister": true,
      "spot_price": "3",
      "security_group_id": "sg-af6d98c8",
      "subnet_id": "subnet-404a7937",
      "ami_block_device_mappings": [
        {
          "device_name": "/dev/sda1",
          "volume_size": "32",
          "delete_on_termination": true,
          "volume_type": "gp2"
        }
      ],
      "launch_block_device_mappings": [
        {
          "device_name": "/dev/sda1",
          "volume_size": "32",
          "delete_on_termination": true,
          "volume_type": "gp2"
        }
      ]
    },
    {
      "type": "docker",
      "image": "wjordan/ubuntu-chef:12.6.0",
      "commit": true,
      "pull": true,
      "volumes": {
        "{{user `root`}}": "/home/ubuntu/adhoc"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "script": "./install-ec2-ami-tools.sh",
      "only": ["amazon-instance"]
    },
    {
      "type": "shell",
      "inline": [
        "sudo -u ubuntu bash -c 'curl https://s3.amazonaws.com/cdo-dist/cdo-bootstrap.sh | sudo bash -s -- -b \"{{user `branch`}}\" -r \"recipe[cdo-apps],recipe[cdo-apps::stop]\"'"
      ]
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-tag",
        "repository": "wjordan/code-dot-org",
        "tag": "0.2",
        "force": true,
        "only": ["docker"]
      },
      {
        "type": "docker-push",
        "only": ["docker"]
      }
    ]
  ]
}
