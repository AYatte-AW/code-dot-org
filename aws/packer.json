{
  "variables": {
    "branch": "staging",
    "root": "{{pwd}}"
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "us-west-2",
      "availability_zone": "us-west-2b",
      "source_ami": "ami-9abea4fb",
      "instance_type": "m4.4xlarge",
      "ssh_username": "ubuntu",
      "ami_name": "cdo-{{timestamp}}",
      "ami_groups": "all",
      "associate_public_ip_address": true,
      "force_deregister": true,
      "spot_price": "2",
      "security_group_id": "sg-af6d98c8",
      "subnet_id": "subnet-404a7937",
      "ami_block_device_mappings": [
        {
          "device_name": "/dev/sda1",
          "volume_size": "64",
          "delete_on_termination": true,
          "volume_type": "gp2"
        }
      ],
      "launch_block_device_mappings": [
        {
          "device_name": "/dev/sda1",
          "volume_size": "64",
          "delete_on_termination": true,
          "volume_type": "gp2"
        }
      ]
    },
    {
      "type": "docker",
      "image": "wjordan/ubuntu-chef",
      "commit": true,
      "pull": true,
      "volumes": {
        "{{user `root`}}": "/home/ubuntu/adhoc"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sudo mkdir -p /var/chef/environments && sudo mkdir -p /var/chef/cookbooks && sudo chown -R ubuntu:ubuntu /var/chef",
        "sudo mkdir -p /tmp/packer-chef-client && sudo chown -R ubuntu:ubuntu /tmp/packer-chef-client"
      ]
    },
    {
      "type": "file",
      "source": "../cookbooks/.berkshelf/",
      "destination": "/var/chef/cookbooks"
    },
    {
      "type": "file",
      "source": "../cookbooks/cdo-apps/test/environments/",
      "destination": "/var/chef/environments"
    },
    {
      "type": "chef-client",
      "install_command": "[ -d /opt/chef/bin ] && true || curl -L https://www.chef.io/chef/install.sh | {{if .Sudo}}sudo{{end}} bash -s -- -v 11.18.12",
      "execute_command": "echo $(id -u ubuntu) > /proc/self/loginuid 2>/dev/null; sudo chef-client -z --no-color -c {{.ConfigPath}} -j {{.JsonPath}}",
      "chef_environment": "adhoc",
      "node_name": "cdo-adhoc",
      "server_url": "http://localhost:8889",
      "skip_clean_node": true,
      "skip_clean_client": true,
      "run_list": [
        "apt",
        "cdo-mysql::server",
        "cdo-apps",
        "cdo-apps::stop"
      ],
      "config_template": "./client.rb.template",
      "json": {
        "cdo-repository": {
          "branch": "{{user `branch`}}"
        }
      }
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-tag",
        "repository": "wjordan/code-dot-org",
        "tag": "0.2",
        "force": true,
        "only": ["docker"]
      },
      {
        "type": "docker-push",
        "only": ["docker"]
      }
    ]
  ]
}
