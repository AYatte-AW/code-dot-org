#!/usr/bin/env ruby

# This script downloads and processes a YouTube video by ID,
# making it available for viewing through Code.org's fallback video player.

# Usage:
# bin/youtube [id]
# Dependency requirements:
# viddl-rb (`gem install viddl-rb`) - for downloading the video
# ffmpeg (`sudo apt-get install ffmpeg`) - for transcoding the downloaded video into mp4 (if necessary)

require_relative '../deployment'
require 'cdo/aws/s3'
require 'tmpdir'
require 'open-uri'

id = ARGV.first
url = "www.youtube.com/watch?v=#{id}"

Dir.mktmpdir do |dir|
  bucket = 'videos.code.org'

  `viddl-rb #{url} -s #{dir}`
  file = Dir.glob("#{dir}/*").first
  if File.extname(file) != '.mp4'
    new_file = "#{dir}/#{File.basename(file,'.*')}.mp4"
    puts `ffmpeg -i "#{file}" -strict -2 "#{new_file}"`
    file = new_file
  end
  filename = AWS::S3.upload_to_bucket(bucket, "youtube/#{id}.mp4", File.open(file), access: :public_read, no_random: true)
  puts "https://#{bucket}/#{filename}"

  thumbnail_file = "https://i.ytimg.com/vi/#{id}/0.jpg"
  thumbnail_filename = AWS::S3.upload_to_bucket(bucket, "youtube/#{id}.jpg", open(thumbnail_file), access: :public_read, no_random: true)
  puts "https://#{bucket}/#{thumbnail_filename}"
end
