#!/usr/bin/env ruby

# The map on code.org/yourschool is run off of a Google Fusion Table
# (documentation: https://developers.google.com/maps/documentation/javascript/fusiontableslayer).
# This script updates the fusion table using the REST API
# (documentation: https://developers.google.com/fusiontables/docs/v2/using),
# populating it with all rows from the census_summaries table for the appropriate school year.

# After setting up authentication, provide the following CDO.* attributes:
#   CDO.hoc_map_account: (JSON of a credential which can edit the FusionTables table)
#   CDO.census_map_table_id: (the id of the fusion table)

require File.expand_path('../../../pegasus/src/env', __FILE__)
require src_dir 'database'
require 'cdo/properties'
require 'dynamic_config/dcdo'

DB_READONLY = Sequel.connect(CDO.pegasus_db_reader.sub('mysql:', 'mysql2:'))

year = Date.today.year - 1

geojson = JSON.parse('{ "type": "FeatureCollection", "features": [] }')

  File.open("/home/ubuntu/code-dot-org/pegasus/sites.v3/code.org/public/volunteers2.json", 'w') do |file|
      DB_READONLY[:forms].where(kind: 'VolunteerEngineerSubmission2015').paged_each(rows_per_fetch: 10) do |form|
        data = JSON.parse(form[:data])
        processed_data = JSON.parse(form[:processed_data]) rescue {}
        next if processed_data.blank?
        coordinates = processed_data['location_p'].split(',')

        geojson["features"] << 
          {
            geometry: {
              coordinates: [coordinates[1].to_i, coordinates[0].to_i],
              type: "Point"
            },
            "properties": {
            },
            type: "Feature"
          }
      end
    file.write(JSON.pretty_generate(geojson))
  end
