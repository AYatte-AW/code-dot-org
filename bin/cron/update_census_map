#!/usr/bin/env ruby

# The map on code.org/yourschool is run off of a Google Fusion Table
# (documentation: https://developers.google.com/maps/documentation/javascript/fusiontableslayer).
# This script updates the fusion table using the REST API
# (documentation: https://developers.google.com/fusiontables/docs/v2/using),
# populating it with all rows from the census_summaries table for the appropriate school year.

# After setting up authentication, provide the following CDO.* attributes:
#   CDO.hoc_map_account: (JSON of a credential which can edit the FusionTables table)
#   CDO.census_map_table_id: (the id of the fusion table)

require File.expand_path('../../../pegasus/src/env', __FILE__)
require src_dir 'database'
require 'cdo/properties'
require 'dynamic_config/dcdo'

DB_READONLY = Sequel.connect(CDO.pegasus_db_reader.sub('mysql:', 'mysql2:'))

year = Date.today.year - 1

geojson = JSON.parse('{ "type": "FeatureCollection", "features": [] }')
count = 0

  File.open("/home/ubuntu/code-dot-org/pegasus/sites.v3/code.org/public/world.json", 'w') do |file|
#      DB_READONLY[:forms].where(kind: 'VolunteerEngineerSubmission2015').paged_each(rows_per_fetch: 10) do |form|
    until count > 200000 do
      count = count + 1
      long = rand() * 180*2 - 180
      lat = rand() * 85*2 - 85

        geojson["features"] << 
          {
            geometry: {
              coordinates: [long, lat],
              type: "Point"
            },
            "properties": {
              description: count.to_s
            },
            type: "Feature"
          }
      end
    file.write(JSON.pretty_generate(geojson))
  end
