#!/usr/bin/env ruby

require_relative '../../dashboard/config/environment'
require 'aws-sdk'
require 'cdo/cron_helper'
require 'cdo/only_one'

TASK_NAME = 'Backup S3 To Secondary Account'.freeze
DEBUG_OUTPUT = false

BACKUP_BUCKET_ROOT = 'cdo-secondary-backup'.freeze
S3S3MIRROR_DIR = "/home/ubuntu/s3s3mirror/".freeze
S3S3MIRROR_COMMAND = 's3s3mirror.sh'.freeze
S3S3MIRROR_INSTALL_COMMAND = "git clone https://github.com/cobbzilla/s3s3mirror.git #{S3S3MIRROR_DIR}".freeze

BUCKETS_TO_SKIP = [
  'cdo-analysis-firehose',
  'cdo-art', # 120M elements, 7.1tb, seems to be safe to skip
  'cdo-dist', # 170k, 31gb, unnecessary
  'cdo-dynamo-backup', # 81k, 15gb
  'cdo-logs', # 20M, 12tb, skip!
  'cucumber-logs', # 1.5M, 80gb
  'pd-workshop-surveys',
].freeze

BUCKETS_TO_BACKUP = [
  'amis-for-475661607190-in-us-east-1-wsc4j6no',
  'aws-athena-query-results-475661607190-us-east-1',
  'aws-logs-475661607190-us-east-1',
  'cdo-ami',
  'cdo-j5-test',
  'cdo-mc-test',
  'cdo-rubygems-mirror',
  'cdo-sound-library',
  'codedotorg',
  'computinginthecore.com',
  'computinginthecore.net',
  'computinginthecore.org',
  'downloads.computinginthecore.org',
  'www.computinginthecore.com',
  'www.computinginthecore.net',
  'www.computinginthecore.org',
  'audio.code.org',
  'cdo-animation-library',
  'cdo-backups',
  'cdo-build-logs',
  'cdo-build-package',
  'cdo-circle-utils',
  'cdo-curriculum',
  'cdo-email-images',
  'cdo-error',
  'cdo-fetch', # 10k, 9gb
  'cdo-form-uploads', # 10k, 1.2gb
  'cdo-lib',
  'cdo-map-reduce',
  'cdo-offline-2',
  'cdo-offline-hoc',
  'cdo-offline',
  'cdo-repo',
  'cdo-temp', # 35k, 2mb
  'cdo-travisci',
  'cdo-tts', # 2.5k, 500mb
  'cdo-v3-animations', # 4k, 190mb
  'cdo-v3-assets', # 455k, 250gb
  'cdo-v3-files',
  'cdo-v3-prod-firebase-backups',
  'cdo-v3-sources-contributors',
  'cdo-v3-sources', # 5M, 30gb
  'cdo-videos',
  'cf-templates-p9nfb0gyyrpf-us-east-1',
  'codepipeline-us-east-1-418960518203',
  'deprecated-data',
  'dms-cwnluin4utwebpwk33pew5qnem',
  'downloads.code.org',
  'firehose-analysis-events',
  'hoc-static-all',
  'hoc-static',
  'images.code.org',
  'learn.dev-code',
  'offline-apps',
  'redshift-tableau', # 25k, 65gb
  'tableau-connector',
  'videos.code.org' # 714, 30gb
].freeze

LIST_BUCKETS_COMMAND = 'aws s3 ls | awk \'{ print $3 }\''
def verify_bucket_list
  buckets_output = `#{LIST_BUCKETS_COMMAND}`
  buckets = buckets_output.split("\n")
  all_mentioned_buckets = (BUCKETS_TO_BACKUP + BUCKETS_TO_SKIP)
  mentioned_not_found = all_mentioned_buckets - buckets
  found_not_mentioned = buckets - all_mentioned_buckets
  unless mentioned_not_found.empty?
    message = "S3 buckets were listed in backup_buckets_to_secondary_account, but not found on account:\n"
    mentioned_not_found.each do |bucket|
      message += bucket + "\n"
    end
    HipChat.log message, color: 'red'
  end
  unless found_not_mentioned.empty?
    message = "S3 buckets were found in account that are not listed in backup_buckets_to_secondary_account:\n"
    found_not_mentioned.each do |bucket|
      message += bucket + "\n"
    end
    HipChat.log message, color: 'red'
  end
end

def ensure_s3s3mirror_installed
  file_exists = File.file? "#{S3S3MIRROR_DIR}#{S3S3MIRROR_COMMAND}"
  `#{S3S3MIRROR_INSTALL_COMMAND}` unless file_exists
end

def debug_puts(text)
  puts text if DEBUG_OUTPUT
end

def main
  unless only_one_running?(__FILE__)
    CronHelper.report_cron_daily_result TASK_NAME, false
    HipChat.log 'S3 backup task failed, previous task is still running!', color: 'red', notify: 1
    return
  end

  ensure_s3s3mirror_installed

  verify_bucket_list

  start_time = Time.now
  debug_puts "Beginning S3 backup sync at #{Time.now}"
  HipChat.log("Beginning S3 backup sync at #{Time.now}")

  # s3s3mirror does not function properly if you're not in its root directory
  Dir.chdir(S3S3MIRROR_DIR)
  BUCKETS_TO_BACKUP.each do |bucket_name|
    debug_puts "Backing up #{bucket_name}"
    # -C marks this as a cross-account copy
    backup_command = "#{S3S3MIRROR_DIR}#{S3S3MIRROR_COMMAND} -C #{bucket_name} #{BACKUP_BUCKET_ROOT}/#{bucket_name}/"
    debug_puts "Running command: #{backup_command}"
    result = `#{backup_command}`
    debug_puts result
  end

  debug_puts 'S3 backup sync complete'
  end_time = Time.now
  debug_puts "Time elapsed: #{end_time - start_time}"
  HipChat.log("S3 backup sync complete at #{Time.now}")
  CronHelper.report_cron_daily_result TASK_NAME, true
end

main
